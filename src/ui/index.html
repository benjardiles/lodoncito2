<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mi App Electron</title>
  <link rel="stylesheet" href="./bootstrap.min(2).css">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div class="container">
    <h1>Productos</h1>
    <div class="content">
      <div class="form-section">
        <h2>Agregar Producto</h2>
        <form id="product-form" class="product-form">
          <input type="hidden" id="product-id">
          <input type="text" id="nombre" placeholder="Nombre" required>
          <br>
          <input type="text" id="tipo" placeholder="Tipo" required>
          <br>
          <input type="text" id="marca" placeholder="Marca" required>
          <br>
          <input type="text" id="estiloGraduacion" placeholder="Estilo Graduacion" required>
          <br>
          <input type="number" id="cantidad" placeholder="Cantidad" required>
          <br>
          <input type="number" id="stock_critico" placeholder="Stock Crítico" required>
          <br>
          <input type="text" id="id_proveedor" placeholder="ID Proveedor" required>
          <br>
          <button type="submit" class="btn btn-primary">Guardar Producto</button>
        </form>
      </div>
      <div class="product-list-container">
        <nav class="navbar">
          <div class="filter-sort">
            <select id="provider-filter" class="form-select">
              <!-- Aquí se agregarán los proveedores dinámicamente -->
            </select>
            <select id="sort-order" class="form-select">
              <option value="asc">Ordenar: Menor a Mayor</option>
              <option value="desc">Ordenar: Mayor a Menor</option>
            </select>
          </div>
        </nav>
        <ul id="product-list" class="product-list"></ul>
        <h2>Productos Eliminados</h2>
        <ul id="deleted-product-list" class="product-list"></ul>
      </div>
    </div>

    <!-- Botón para abrir la página de proveedores -->
    <button id="open-providers" class="btn btn-secondary">Ver Proveedores</button>
  </div>

  <script>
    const form = document.getElementById('product-form');
    const productList = document.getElementById('product-list');
    const deletedProductList = document.getElementById('deleted-product-list');
    const openProvidersButton = document.getElementById('open-providers');
    const providerFilter = document.getElementById('provider-filter');
    const sortOrder = document.getElementById('sort-order');

    let deletedProducts = [];

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const productId = form['product-id'].value;
      const product = {
        nombre: form.nombre.value,
        tipo: form.tipo.value,
        marca: form.marca.value,
        estiloGraduacion: form.estiloGraduacion.value,
        cantidad: form.cantidad.value,
        stock_critico: form.stock_critico.value,
        id_proveedor: form.id_proveedor.value,
      };

      if (productId) {
        // Update existing product
        const updatedProduct = await window.api.updateProduct(productId, product);
        console.log('Product updated:', updatedProduct);

        // Check if the updated product's stock is equal or less than the critical stock
        if (parseInt(product.cantidad) <= parseInt(product.stock_critico)) {
          alert(`Atención: El stock del producto ${product.nombre} ha alcanzado o está por debajo del nivel crítico.`);
        }

      } else {
        // Create new product
        const newProduct = await window.api.createProduct(product);
        console.log('Product created:', newProduct);

        // Check if the new product's stock is equal or less than the critical stock
        if (parseInt(product.cantidad) <= parseInt(product.stock_critico)) {
          alert(`Atención: El stock del producto ${product.nombre} ha alcanzado o está por debajo del nivel crítico.`);
        }
      }

      form.reset();
      loadProducts();
    });

    openProvidersButton.addEventListener('click', () => {
      window.api.openProvidersWindow();
    });

    providerFilter.addEventListener('change', loadProducts);
    sortOrder.addEventListener('change', loadProducts);

    async function loadProducts() {
      let products = await window.api.getProducts();

      // Filtrar por proveedor
      const provider = providerFilter.value;
      if (provider) {
        products = products.filter(product => product.id_proveedor === provider);
      }

      // Ordenar los productos
      const order = sortOrder.value;
      products = products.sort((a, b) => {
        const quantityA = parseInt(a.cantidad);
        const quantityB = parseInt(b.cantidad);
        if (order === 'asc') {
          return quantityA - quantityB;
        } else {
          return quantityB - quantityA;
        }
      });

      productList.innerHTML = '';
      products.forEach(product => {
        const li = document.createElement('li');
        li.className = 'product-list-item';

        const productInfo = document.createElement('div');
        productInfo.className = 'product-info';
        productInfo.textContent = `${product.nombre} - ${product.marca} - ${product.tipo} - ${product.estiloGraduacion} - ${product.cantidad} - ${product.stock_critico}`;
        li.appendChild(productInfo);

        const buttonGroup = document.createElement('div');
        buttonGroup.className = 'button-group';

        const editButton = document.createElement('button');
        editButton.textContent = 'Editar';
        editButton.className = 'btn btn-sm btn-warning';
        editButton.addEventListener('click', () => loadProductIntoForm(product));
        buttonGroup.appendChild(editButton);

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Eliminar';
        deleteButton.className = 'btn btn-sm btn-danger';
        deleteButton.addEventListener('click', () => confirmDeleteProduct(product));
        buttonGroup.appendChild(deleteButton);

        // Botón para incrementar el stock
        const incrementButton = document.createElement('button');
        incrementButton.textContent = '+';
        incrementButton.className = 'btn btn-sm btn-success';
        incrementButton.addEventListener('click', () => changeProductQuantity(product.id, 1));
        buttonGroup.appendChild(incrementButton);

        // Botón para decrementar el stock
        const decrementButton = document.createElement('button');
        decrementButton.textContent = '-';
        decrementButton.className = 'btn btn-sm btn-secondary';
        decrementButton.addEventListener('click', () => changeProductQuantity(product.id, -1));
        buttonGroup.appendChild(decrementButton);

        li.appendChild(buttonGroup);
        productList.appendChild(li);
      });
    }

    function confirmDeleteProduct(product) {
      const confirmation = confirm(`¿Estás seguro de que deseas eliminar el producto ${product.nombre}?`);
      if (confirmation) {
        deleteProduct(product);
      }
    }

    async function deleteProduct(product) {
      await window.api.deleteProduct(product.id);
      console.log('Product deleted:', product.id);
      deletedProducts.push(product);
      loadProducts();
      loadDeletedProducts();
    }

    async function changeProductQuantity(productId, change) {
      const product = await window.api.getProductById(productId);
      if (product) {
        product.cantidad = parseInt(product.cantidad) + change;
        if (product.cantidad < 0) {
          product.cantidad = 0;
        }
        if (product.cantidad <= product.stock_critico) {
          alert(`Atención: El stock del producto ${product.nombre} ha alcanzado el nivel crítico.`);
        }
        await window.api.updateProduct(productId, product);
        loadProducts();
      }
    }

    function loadDeletedProducts() {
      deletedProductList.innerHTML = '';
      deletedProducts.forEach(product => {
        const li = document.createElement('li');
        li.className = 'product-list-item';

        const productInfo = document.createElement('div');
        productInfo.className = 'product-info';
        productInfo.textContent = `${product.nombre} - ${product.marca} - ${product.tipo} - ${product.estiloGraduacion} - ${product.cantidad} - ${product.stock_critico}`;
        li.appendChild(productInfo);

        const buttonGroup = document.createElement('div');
        buttonGroup.className = 'button-group';

        const restoreButton = document.createElement('button');
        restoreButton.textContent = 'Restablecer';
        restoreButton.className = 'btn btn-sm btn-success';
        restoreButton.addEventListener('click', () => restoreProduct(product));
        buttonGroup.appendChild(restoreButton);

        li.appendChild(buttonGroup);
        deletedProductList.appendChild(li);
      });
    }

    async function restoreProduct(product) {
      await window.api.createProduct(product);
      console.log('Product restored:', product.id);
      deletedProducts = deletedProducts.filter(p => p.id !== product.id);
      loadProducts();
      loadDeletedProducts();
    }

    async function loadProviders() {
      const providers = await window.api.getProviders();
      providerFilter.innerHTML = '<option value="">Todos los Proveedores</option>';
      providers.forEach(provider => {
        const option = document.createElement('option');
        option.value = provider.id;
        option.textContent = provider.nombre;
        providerFilter.appendChild(option);
      });
    }

   


    function loadProductIntoForm(product) {
      form['product-id'].value = product.id;
      form.nombre.value = product.nombre;
      form.tipo.value = product.tipo;
      form.marca.value = product.marca;
      form.estiloGraduacion.value = product.estiloGraduacion;
      form.cantidad.value = product.cantidad;
      form.stock_critico.value = product.stock_critico;
      form.id_proveedor.value = product.id_proveedor;
    }

    loadProducts();
    loadProviders();
  </script>
</body>
</html>
