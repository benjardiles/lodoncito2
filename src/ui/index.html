<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mi App Electron</title>
  <link rel="stylesheet" href="./bootstrap.min(2).css">
  <link rel="stylesheet" href="./styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- <h1>Productos</h1> -->
    <div class="content">
      <div class="form-section">
        <h2>Agregar Producto</h2>
        <form id="product-form" class="product-form">
          <input type="hidden" id="product-id">
          <br>
          <input type="text" id="tipo" placeholder="Tipo" required>
          <br>
          <input type="text" id="marca" placeholder="Marca" required>
          <br>
          <input type="text" id="estilo_graduacion" placeholder="Estilo Graduacion" required>
          <br>
          <input type="number" id="cantidad" placeholder="Cantidad" required>
          <br>
          <input type="number" id="stock_critico" placeholder="Stock Crítico" required>
          <br>
          <select id="id_proveedor" placeholder="Proveedor" required>
            <!-- Aquí se agregarán los proveedores dinámicamente -->
          </select>
          <br>
          <button type="submit" class="btn btn-primary">Guardar Producto</button>
        </form>
      </div>
      <div class="product-list-container">
        <nav class="navbar">
          <div class="filter-sort">
            <input type="text" id="search-bar" placeholder="Buscar...">
            <select id="provider-filter" class="form-select"></select>
            <select id="sort-order" class="form-select">
              <option value="none">Ordenar: Sin Orden</option>
              <option value="asc">Ordenar: Menor a Mayor</option>
              <option value="desc">Ordenar: Mayor a Menor</option>
            </select>
          </div>
        </nav>
        <ul id="product-list" class="product-list"></ul>
      </div>
    </div>

    <button id="open-providers" class="btn btn-secondary">Ver Proveedores</button>
    <button id="export-excel" class="btn btn-success">Exportar a Excel</button>
  </div>

  <script>
    const form = document.getElementById('product-form');
    const productList = document.getElementById('product-list');
    
    const openProvidersButton = document.getElementById('open-providers');
    const providerFilter = document.getElementById('provider-filter');
    const providersSelect = document.getElementById('id_proveedor');
    const sortOrder = document.getElementById('sort-order');
    const searchBar = document.getElementById('search-bar');

    let deletedProducts = [];

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const productId = form['product-id'].value;
      const product = {
        tipo: form.tipo.value,
        marca: form.marca.value,
        estilo_graduacion: form.estilo_graduacion.value,
        cantidad: form.cantidad.value,
        stock_critico: form.stock_critico.value,
        id_proveedor: form.id_proveedor.value,
      };
      
      if (productId) {
        const updatedProduct = await window.api.updateProduct(productId, product);
        console.log('Product updated:', updatedProduct);

        if (parseInt(product.cantidad) <= parseInt(product.stock_critico)) {
          alert(`Atención: El stock del producto ${product.tipo} ha alcanzado o está por debajo del nivel crítico.`);
        }

      } else {
        const newProduct = await window.api.createProduct(product);
        console.log('Product created:', newProduct);

        if (parseInt(product.cantidad) <= parseInt(product.stock_critico)) {
          alert(`Atención: El stock del producto ${product.tipo} ha alcanzado o está por debajo del nivel crítico.`);
        }
      }

      form.reset();
      loadProducts();
    });

    openProvidersButton.addEventListener('click', () => {
      window.api.openProvidersWindow();
    });

    providerFilter.addEventListener('change', loadProducts);
    sortOrder.addEventListener('change', loadProducts);
    searchBar.addEventListener('input', filterProductsByName);

    async function loadProducts() {
      let products = await window.api.getProducts();

      const provider = providerFilter.value;
      if (provider) {
        products = products.filter(product => product.id_proveedor === provider);
      }

      const order = sortOrder.value;
      if (order === 'asc') {
        products = products.sort((a, b) => parseInt(a.cantidad) - parseInt(b.cantidad));
      } else if (order === 'desc') {
        products = products.sort((a, b) => parseInt(b.cantidad) - parseInt(a.cantidad));
      }

      productList.innerHTML = '';
      products.forEach(product => {
        const li = document.createElement('li');
        li.className = 'product-list-item';

        const productInfo = document.createElement('div');
        productInfo.className = 'product-info';
        productInfo.textContent = `${product.marca} - ${product.tipo} - ${product.estilo_graduacion} - ${product.cantidad} - ${product.stock_critico}`;
        li.appendChild(productInfo);

        const buttonGroup = document.createElement('div');
        buttonGroup.className = 'button-group';

        const editButton = document.createElement('button');
        editButton.textContent = 'Editar';
        editButton.className = 'btn btn-sm btn-warning';
        editButton.addEventListener('click', () => loadProductIntoForm(product));
        buttonGroup.appendChild(editButton);

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Eliminar';
        deleteButton.className = 'btn btn-sm btn-danger';
        deleteButton.addEventListener('click', () => confirmDeleteProduct(product));
        buttonGroup.appendChild(deleteButton);

        const incrementButton = document.createElement('button');
        incrementButton.textContent = '+';
        incrementButton.className = 'btn btn-sm btn-success';
        incrementButton.addEventListener('click', () => changeProductQuantity(product.id, 1));
        buttonGroup.appendChild(incrementButton);

        const decrementButton = document.createElement('button');
        decrementButton.textContent = '-';
        decrementButton.className = 'btn btn-sm btn-secondary';
        decrementButton.addEventListener('click', () => changeProductQuantity(product.id, -1));
        buttonGroup.appendChild(decrementButton);

        li.appendChild(buttonGroup);
        productList.appendChild(li);
      });

      filterProductsByName();
    }

    function filterProductsByName() {
      const query = searchBar.value.toLowerCase();
      const productItems = document.querySelectorAll('.product-list-item');

      productItems.forEach(item => {
        const productName = item.querySelector('.product-info').textContent.toLowerCase();
        if (productName.includes(query)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    }

    function confirmDeleteProduct(product) {
      const confirmation = confirm(`¿Estás seguro de que deseas eliminar el producto ${product.tipo}?`);
      if (confirmation) {
        deleteProduct(product);
      }
    }

    async function deleteProduct(product) {
      await window.api.deleteProduct(product.id);
      console.log('Product deleted:', product.id);
      deletedProducts.push(product);
      loadProducts();
      loadDeletedProducts();
    }

    async function changeProductQuantity(productId, change) {
      const product = await window.api.getProductById(productId);
      if (product) {
        product.cantidad = parseInt(product.cantidad) + change;
        if (product.cantidad < 0) {
          product.cantidad = 0;
        }
        if (product.cantidad <= product.stock_critico) {
          alert(`Atención: El stock del producto ${product.tipo} ha alcanzado el nivel crítico.`);
        }
        await window.api.updateProduct(productId, product);
        loadProducts();
      }
    }

    function loadDeletedProducts() {
      deletedProductList.innerHTML = '';
      deletedProducts.forEach(product => {
        const li = document.createElement('li');
        li.className = 'product-list-item';

        const productInfo = document.createElement('div');
        productInfo.className = 'product-info';
        productInfo.textContent = `${product.marca} - ${product.tipo} - ${product.estilo_graduacion} - ${product.cantidad} - ${product.stock_critico}`;
        li.appendChild(productInfo);

        const buttonGroup = document.createElement('div');
        buttonGroup.className = 'button-group';
      });
    }

    async function restoreProduct(productId) {
      const restoredProduct = await window.api.restoreProduct(productId);
      if (restoredProduct) {
        deletedProducts = deletedProducts.filter(product => product.id !== productId);
        loadProducts();
        loadDeletedProducts();
      }
    }

    function loadProductIntoForm(product) {
      form['product-id'].value = product.id;
      form.tipo.value = product.tipo;
      form.marca.value = product.marca;
      form.estilo_graduacion.value = product.estilo_graduacion;
      form.cantidad.value = product.cantidad;
      form.stock_critico.value = product.stock_critico;
      form.id_proveedor.value = product.id_proveedor;
    }

    async function loadProviders() {
      const providers = await window.api.getProviders();
      console.log(providers)
      providerFilter.innerHTML = '<option value="">Todos los proveedores</option>';
      providers.forEach(provider => {
        const option = document.createElement('option');
        option.value = provider.id;
        option.textContent = provider.nombre;
        providerFilter.appendChild(option);
      });
    }

    async function loadProvidersSelect() {
      const providers = await window.api.getProviders();
      console.log(providers)
      providersSelect.innerHTML = '<option value="">Selecciona un proveedor</option>';
      providers.forEach(provider => {
        const option = document.createElement('option');
        option.value = provider.id;
        option.textContent = provider.nombre;
        providersSelect.appendChild(option);
      });
    }

    async function exportToExcel() {
      const products = await window.api.getProducts();
      const worksheetData = products.map(product => ({
        Tipo: product.tipo,
        Marca: product.marca,
        EstiloGraduacion: product.estilo_graduacion,
        Cantidad: product.cantidad,
        StockCritico: product.stock_critico,
        Proveedor: product.id_proveedor
      }));

      const worksheet = XLSX.utils.json_to_sheet(worksheetData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Productos');

      XLSX.writeFile(workbook, 'productos.xlsx');
    }

    loadProducts();
    loadProviders();
    loadProvidersSelect();

    document.getElementById('export-excel').addEventListener('click', exportToExcel);
  </script>
</body>
</html>
